#!/usr/bin/env bash

set -e

export PATH="${PATH}:./node_modules/.bin"
export TARGET="${TARGET:-./index}"

MODE=$1
shift 1

mkdir -p "$(dirname "${TARGET}")"

pbjs \
    --force-number \
    --force-message \
    -t static-module \
    -w default \
    -o "${TARGET}.js" \
    --root "${TARGET}" \
    "$@"

if [ "$MODE" = "fix" ]; then
    # TODO: Remove this hack
    sed -i.bak 's@return $root;@$root.api = $root.replit.goval.api; return $root;@' "${TARGET}.js"
    rm -f "${TARGET}.js.bak"
fi

./jsdoc.js <"${TARGET}.js" >"${TARGET}.tmp.js"

mv "${TARGET}.tmp.js" "${TARGET}.js"

pbts -o "${TARGET}.d.ts" "${TARGET}.js"

if [ "$MODE" = "fix" ]; then
    # TODO: Remove this hack
    echo 'import api = replit.goval.api; export { api };' >> "${TARGET}.d.ts"
fi

sed -i.bak 's/constructor(/private constructor(/' "${TARGET}.d.ts"

rm -f "${TARGET}.d.ts.bak"
flowgen \
    --interface-records \
    --no-inexact \
    --add-flow-header \
    --output-file "${TARGET}.js.flow" "${TARGET}.d.ts"

if [ "$MODE" = "fix" ]; then
    sed -i.bak 's/declare var replit: typeof npm\$namespace\$replit;/export var replit = npm$namespace$replit;/' "${TARGET}.js.flow"
    sed -i.bak 's/declare var google: typeof npm\$namespace\$google;/export var google = npm$namespace$google;/' "${TARGET}.js.flow"
    sed -i.bak 's/declare export { api };/export var api = npm$namespace$replit$goval$api;/' "${TARGET}.js.flow"
    rm -f "${TARGET}.js.flow.bak"
fi
